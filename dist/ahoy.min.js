!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).ahoy=e()}(this,function(){"use strict";function e(t){return void 0===t}function s(t){return Array.isArray(t)}function c(t){return t&&"number"==typeof t.size&&"string"==typeof t.type&&"function"==typeof t.slice}var r=function i(n,r,o,a){if(function(t){return t instanceof FormData}(r)&&(a=o,o=r,r=null),(r=r||{}).indices=!e(r.indices)&&r.indices,r.nulls=!!e(r.nulls)||r.nulls,o=o||new FormData,e(n))return o;if(function(t){return null===t}(n))r.nulls&&o.append(a,"");else if(s(n))if(n.length)n.forEach(function(t,e){var n=a+"["+(r.indices?e:"")+"]";i(t,r,o,n)});else{var t=a+"[]";o.append(t,"")}else!function(t){return t instanceof Date}(n)?!function(t){return t===Object(t)}(n)||function(t){return c(t)&&("object"==typeof t.lastModifiedDate||"number"==typeof t.lastModified)&&"string"==typeof t.name}(n)||c(n)?o.append(a,n):Object.keys(n).forEach(function(t){var e=n[t];if(s(e))for(;2<t.length&&t.lastIndexOf("[]")===t.length-2;)t=t.substring(0,t.length-2);i(e,r,o,a?a+"["+t+"]":t)}):o.append(a,n.toISOString());return o},i={set:function(t,e,n,i){var r="",o="";if(n){var a=new Date;a.setTime(a.getTime()+60*n*1e3),r="; expires="+a.toGMTString()}i&&(o="; domain="+i),document.cookie=t+"="+escape(e)+r+o+"; path=/"},get:function(t){var e,n,i=t+"=",r=document.cookie.split(";");for(e=0;e<r.length;e++){for(n=r[e];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(i))return unescape(n.substring(i.length,n.length))}return null}},o={urlPrefix:"",visitsUrl:"/ahoy/visits",eventsUrl:"/ahoy/events",page:null,platform:"Web",useBeacon:!0,startOnReady:!0,trackVisits:!0,cookies:!0,cookieDomain:null,headers:{},visitParams:{},withCredentials:!1},a=window.ahoy||window.Ahoy||{};a.configure=function(t){for(var e in t)t.hasOwnProperty(e)&&(o[e]=t[e])},a.configure(a);var n,u,f,t,d=window.jQuery||window.Zepto||window.$,l=!1,h=[],v="undefined"!=typeof JSON&&void 0!==JSON.stringify,g=[];function p(){return o.urlPrefix+o.eventsUrl}function y(){return(o.useBeacon||o.trackNow)&&function(t){return 0===Object.keys(t).length}(o.headers)&&v&&void 0!==window.navigator.sendBeacon&&!o.withCredentials}function m(t,e,n){i.set(t,e,n,o.cookieDomain||o.domain)}function k(t){return i.get(t)}function w(t){i.set(t,"",-1)}function x(t){k("ahoy_debug")&&window.console.log(t)}function _(){for(var t;t=h.shift();)t();l=!0}function b(t){l?t():h.push(t)}function S(t,e,n){document.addEventListener(t,function(t){!function(t,e){var n=t.matches||t.matchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector;return n?n.apply(t,[e]):(x("Unable to match"),!1)}(t.target,e)||n(t)})}function O(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}function C(){o.cookies&&v&&m("ahoy_events",JSON.stringify(g),1)}function T(){var t=document.querySelector("meta[name=csrf-token]");return t&&t.content}function V(t){var e=T();e&&t.setRequestHeader("X-CSRF-Token",e)}function j(t,e,n){if(v)if(d&&d.ajax)d.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json",beforeSend:V,success:n,headers:o.headers,xhrFields:{withCredentials:o.withCredentials}});else{var i=new XMLHttpRequest;for(var r in i.open("POST",t,!0),i.withCredentials=o.withCredentials,i.setRequestHeader("Content-Type","application/json"),o.headers)o.headers.hasOwnProperty(r)&&i.setRequestHeader(r,o.headers[r]);i.onload=function(){200===i.status&&n()},V(i),i.send(JSON.stringify(e))}}function P(t){var e={events:[t]};return o.cookies&&(e.visit_token=t.visit_token,e.visitor_token=t.visitor_token),delete t.visit_token,delete t.visitor_token,e}function M(e){b(function(){j(p(),P(e),function(){for(var t=0;t<g.length;t++)if(g[t].id==e.id){g.splice(t,1);break}C()})})}function N(i){b(function(){var t=P(i),e=function(){var t=document.querySelector("meta[name=csrf-param]");return t&&t.content}(),n=T();e&&n&&(t[e]=n),t.events_json=JSON.stringify(t.events),delete t.events,window.navigator.sendBeacon(p(),r(t))})}function D(){return o.page||window.location.pathname}function I(t){return t&&0<t.length?t:null}function A(t){var e=t.target;return function(t){for(var e in t)t.hasOwnProperty(e)&&null===t[e]&&delete t[e];return t}({tag:e.tagName.toLowerCase(),id:I(e.id),class:I(e.className),page:D(),section:function(t){for(;t&&t!==document;t=t.parentNode)if(t.hasAttribute("data-section"))return t.getAttribute("data-section");return null}(e)})}function J(){if(l=!1,n=a.getVisitId(),u=a.getVisitorId(),f=k("ahoy_track"),!1===o.cookies||!1===o.trackVisits)x("Visit tracking disabled"),_();else if(n&&u&&!f)x("Active visit"),_();else if(n||m("ahoy_visit",n=O(),240),k("ahoy_visit")){x("Visit started"),u||m("ahoy_visitor",u=O(),1051200);var t={visit_token:n,visitor_token:u,platform:o.platform,landing_page:window.location.href,screen_width:window.screen.width,screen_height:window.screen.height,js:!0};for(var e in 0<document.referrer.length&&(t.referrer=document.referrer),o.visitParams)o.visitParams.hasOwnProperty(e)&&(t[e]=o.visitParams[e]);x(t),j(o.urlPrefix+o.visitsUrl,t,function(){w("ahoy_track"),_()})}else x("Cookies disabled"),_()}a.getVisitId=a.getVisitToken=function(){return k("ahoy_visit")},a.getVisitorId=a.getVisitorToken=function(){return k("ahoy_visitor")},a.reset=function(){return w("ahoy_visit"),w("ahoy_visitor"),w("ahoy_events"),w("ahoy_track"),!0},a.debug=function(t){return!1===t?w("ahoy_debug"):m("ahoy_debug","t",525600),!0},a.track=function(t,e){var n={name:t,properties:e||{},time:(new Date).getTime()/1e3,id:O(),js:!0};return b(function(){o.cookies&&!a.getVisitId()&&J(),b(function(){x(n),n.visit_token=a.getVisitId(),n.visitor_token=a.getVisitorId(),y()?N(n):(g.push(n),C(),setTimeout(function(){M(n)},1e3))})}),!0},a.trackView=function(t){var e={url:window.location.href,title:document.title,page:D()};if(t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);a.track("$view",e)},a.trackClicks=function(){S("click","a, button, input[type=submit]",function(t){var e=t.target,n=A(t);n.text="input"==n.tag?e.value:(e.textContent||e.innerText||e.innerHTML).replace(/[\s\r\n]+/g," ").trim(),n.href=e.href,a.track("$click",n)})},a.trackSubmits=function(){S("submit","form",function(t){var e=A(t);a.track("$submit",e)})},a.trackChanges=function(){S("change","input, textarea, select",function(t){var e=A(t);a.track("$change",e)})},a.trackAll=function(){a.trackView(),a.trackClicks(),a.trackSubmits(),a.trackChanges()};try{g=JSON.parse(k("ahoy_events")||"[]")}catch(t){}for(var R=0;R<g.length;R++)M(g[R]);return a.start=function(){J(),a.start=function(){}},t=function(){o.startOnReady&&a.start()},"interactive"===document.readyState||"complete"===document.readyState?t():document.addEventListener("DOMContentLoaded",t),a});
